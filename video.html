<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Video Streaming</title>
    <link href="https://cdn.jsdelivr.net/npm/video.js/dist/video-js.min.css" rel="stylesheet">
    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    <link href="https://cdn.plyr.io/3.7.8/plyr.css" rel="stylesheet">
</head>
<body>
<div class="container">
    <video controls crossorigin playsinline></video>
</div>
<!-- Plyr resources and browser polyfills are specified in the pen settings -->
<!-- Hls.js 0.9.x and 0.10.x both have critical bugs affecting this demo. Using fixed git hash to when it was working (0.10.0 pre-release), until https://github.com/video-dev/hls.js/issues/1790 has been resolved -->
<script src="https://cdn.rawgit.com/video-dev/hls.js/18bb552/dist/hls.min.js"></script>
</body>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const video = document.querySelector('video');

        const videoUUID = '0cfa5baa-767f-466c-b947-31497f9934a8';
        const backEndUrl = 'http://localhost:32540/api/v1';
        const source = `${backEndUrl}/videos/${videoUUID}`;
        const token = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJodHRwOi8vbG9jYWxob3N0L2FwaS92MS9sb2dpbiIsImlhdCI6MTcxMDc1OTM3OCwiZXhwIjoxNzEwNzYyOTc4LCJuYmYiOjE3MTA3NTkzNzgsImp0aSI6ImJ5eGNXZ2oyNEpNR1BCckEiLCJzdWIiOiI5Yjk3YjdiNi04OTRmLTQ4YzEtODRkMi1mYTE1MmMxY2U1NWIiLCJwcnYiOiIyM2JkNWM4OTQ5ZjYwMGFkYjM5ZTcwMWM0MDA4NzJkYjdhNTk3NmY3In0.1NbvGm10bZTLq4Tlc46lWc1QVxwAF_rsxkdFtHanJjs';


        function saveVideoPosition() {
            const data = {
                position: video.currentTime
            };

            fetch(`${source}/watch-time`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                },
                body: JSON.stringify(data)
            })
                .catch(error => console.log('Error saving video position:', error));
        }

        function fetchVideoPosition() {
            return fetch(`${source}/watch-time`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                }
            })
                .then(response => response.json())
                .then(data => {
                    if(data) {
                        video.currentTime = data.data;
                    }
                })
                .catch(error => console.log('Error fetching video position:', error));
        }

        fetchVideoPosition();
        const defaultOptions = {};

        if (!Hls.isSupported()) {
            video.src = source;

            var player = new Plyr(video, defaultOptions);
        } else {
            const hls = new Hls({
                // Добавляем конфигурацию xhrSetup для включения заголовков авторизации
                xhrSetup: function (xhr, url) {
                    xhr.setRequestHeader('Authorization', `Bearer ${token}`);
                }
            });

            hls.loadSource(source);

            hls.on(Hls.Events.MANIFEST_PARSED, function (event, data) {

                const availableQualities = hls.levels.map((l) => l.height)
                availableQualities.unshift(0)

                defaultOptions.quality = {
                    default: 0, //Default - AUTO
                    options: availableQualities,
                    forced: true,
                    onChange: (e) => updateQuality(e),
                }

                defaultOptions.i18n = {
                    qualityLabel: {
                        0: 'Auto',
                    },
                }

                hls.on(Hls.Events.LEVEL_SWITCHED, function (event, data) {
                    var span = document.querySelector(".plyr__menu__container [data-plyr='quality'][value='0'] span")
                    if (hls.autoLevelEnabled) {
                        span.innerHTML = `AUTO (${hls.levels[data.level].height}p)`
                    } else {
                        span.innerHTML = `AUTO`
                    }
                })

                var player = new Plyr(video, defaultOptions);
            });

            hls.attachMedia(video);
            window.hls = hls;
        }

        let savePositionInterval;

        video.addEventListener('play', () => {
            if (!savePositionInterval) {
                savePositionInterval = setInterval(() => {
                    if (!video.paused && !video.ended) {
                        saveVideoPosition();
                    }
                }, 30000);
            }
        });

        video.addEventListener('pause', () => {
            saveVideoPosition();
            clearInterval(savePositionInterval);
            savePositionInterval = null;
        });

        video.addEventListener('ended', () => {
            clearInterval(savePositionInterval);
            savePositionInterval = null;
        });

        function updateQuality(newQuality) {
            if (newQuality === 0) {
                window.hls.currentLevel = -1;
            } else {
                window.hls.levels.forEach((level, levelIndex) => {
                    if (level.height === newQuality) {
                        console.log("Found quality match with " + newQuality);
                        window.hls.currentLevel = levelIndex;
                    }
                });
            }
        }
    });
</script>
</html>
